    {% extends 'base.html' %}

{% block title %}Reports Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Expense Reports</h1>
    
    <!-- Export button -->
    <div class="mb-8">
        <a href="{{ url_for('reports.export_expenses') }}" 
           class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Export Expenses to CSV
        </a>
    </div>
    
    <!-- Year-to-date spending by category -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Year-to-Date Spending by Category</h2>
        <div class="bg-white shadow-lg rounded-lg p-6">
            <canvas id="ytdChart"
                   data-labels="{{ ytd_spending|map(attribute='0')|map(attribute='name')|list|tojson }}"
                   data-values="{{ ytd_spending|map(attribute='1')|list|tojson }}"></canvas>
        </div>
    </div>
    
    <!-- Monthly spending trends -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Monthly Spending Trends</h2>
        <div class="bg-white shadow-lg rounded-lg p-6">
            <canvas id="monthlyTrendsChart"
                   data-labels="{{ monthly_totals|map(attribute='month')|map('string')|map('add', '/')|map('add', now.year|string)|list|tojson }}"
                   data-values="{{ monthly_totals|map(attribute='total')|list|tojson }}"></canvas>
        </div>
    </div>
    
    <!-- Category trends -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Category Trends</h2>
        <div class="stats-grid">
            {% for trend in trends %}
            <div class="stat-card trend">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas {{ trend.category.icon or 'fa-chart-line' }}"></i>
                    </div>
                </div>
                <div class="stat-label">{{ trend.category.name }}</div>
                <div class="stat-value">{{ current_user.currency_symbol }}{{ "{:,.2f}".format(trend.total) }}</div>
                <div class="stat-change">
                    {% if trend.trend > 0 %}
                        <span class="text-danger">↑ {{ trend.trend }}%</span>
                    {% elif trend.trend < 0 %}
                        <span class="text-success">↓ {{ abs(trend.trend) }}%</span>
                    {% else %}
                        <span class="text-muted">−</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Budget vs Actual -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Budget vs Actual (Current Month)</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white shadow-lg rounded-lg">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Category
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Budget
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actual
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Variance
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for item in budget_vs_actual %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ item.category.name }}
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            ${{ "{:,.2f}".format(item.budget or 0) }}
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            ${{ "{:,.2f}".format(item.actual or 0) }}
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            {% if item.variance is not none %}
                                {% if item.variance >= 0 %}
                                    <span class="text-green-500">
                                {% else %}
                                    <span class="text-red-500">
                                {% endif %}
                                ${{ "{:,.2f}".format(abs(item.variance)) }}
                                {% if item.variance >= 0 %}
                                    under
                                {% else %}
                                    over
                                {% endif %}
                                </span>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize both charts
    function initializeCharts() {
        // YTD Spending Chart
        const ytdChart = document.getElementById('ytdChart');
        if (ytdChart) {
            const ytdCtx = ytdChart.getContext('2d');
            const ytdLabels = JSON.parse(ytdChart.dataset.labels || '[]');
            const ytdValues = JSON.parse(ytdChart.dataset.values || '[]');

            new Chart(ytdCtx, {
                type: 'pie',
                data: {
                    labels: ytdLabels,
                    datasets: [{
                        data: ytdValues,
                        backgroundColor: [
                            '#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF',
                            '#FF9F40','#FF6384','#36A2EB','#FFCE56','#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        // Monthly Trends Chart
        const monthlyChart = document.getElementById('monthlyTrendsChart');
        if (monthlyChart) {
            const monthlyCtx = monthlyChart.getContext('2d');
            const monthlyLabels = JSON.parse(monthlyChart.dataset.labels || '[]');
            const monthlyValues = JSON.parse(monthlyChart.dataset.values || '[]');

            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Monthly Total',
                        data: monthlyValues,
                        fill: false,
                        borderColor: '#36A2EB',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '{{ current_user.currency_symbol }}' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '{{ current_user.currency_symbol }}' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    initializeCharts();
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Stats Grid and Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .stat-card.trend::before {
        background: linear-gradient(90deg, var(--secondary) 0%, #8b5cf6 100%);
    }

    .stat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        background: linear-gradient(135deg, var(--secondary) 0%, #8b5cf6 100%);
    }

    .stat-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--gray-900);
        line-height: 1;
    }

    .stat-change {
        font-size: 0.8125rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .stat-card.trend .stat-change {
        color: var(--secondary);
    }

    /* Dark mode styles */
    body.dark-mode .stat-card {
        background: var(--dark-card);
        border-color: var(--dark-border);
    }

    body.dark-mode .stat-label {
        color: var(--gray-400);
    }

    body.dark-mode .stat-value {
        color: var(--gray-100);
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .stat-card {
            padding: 1.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}